{% extends "core/base.html" %}
{% load materializecss %}
{% load static %}
{% block body %}
<div class="section">
    <h4>Place A Ship Order</h4>
</div>
<div class="divider"></div>
<div class="section">
    <form action="" method="post">
        {% csrf_token %}
        <div class="row">
            {{ form.recipient_character|materializecss:'s12 m12, icon=user'}}
        </div>
        <div class="row">
            <div class="col s12 m6">
                {{ form.ship }}
            </div>
            {{ form.quantity|materializecss:'s12 m6, icon=filter_1'}}
        </div>
        <div class="row">
            {{ form.payment_method|materializecss:'s12 m6, icon=attach_money'}}
            {{ form.notes|materializecss:'s12 m6, icon=comment'}}
        </div>
        <div class="row">
            <div id="ship_info_display"></div>
        </div>
        <button class="btn waves-effect waves-light green" type="submit" value="Submit" id="submit_btn">
            Generate Unique Contract Code
            <i class="material-icons right">send</i>
        </button>
    </form>
</div>


{% endblock %}
{% block extrafooter %}
{{ship_data|json_script:"ship_data"}}
<script src="{% static 'admin/js/vendor/jquery/jquery.js' %}" type="text/javascript"></script>
<link href="{% static 'admin/css/vendor/select2/select2.min.css' %}" type="text/css" media="screen" rel="stylesheet">
<script src="{% static 'admin/js/vendor/select2/select2.full.js' %}" type="text/javascript"></script>

<script>

function update_select_text_with_ship_data(ship_data){
    $("#id_ship option").each(function(){
        ship_name = $(this).val();
        ship_info = ship_data[ship_name];
        text = `${ship_name} (T${ship_info.tech_level})`;
        if(ship_info.free){
            if(ship_info.blocked_until){
                text += " - Next Free Ship On: " + ship_info.blocked_until;
            } else {
                text += " - FREE ";
            }
        }
        $(this).text(text);
    })
}

$(document).ready(function() {
    $('#id_ship').select2();
    const ship_data = JSON.parse(document.getElementById('ship_data').textContent);
    update_select_text_with_ship_data(ship_data);
    $('#id_ship').on('change paste keyup', function() { return update_after_ship_change(ship_data); } );
    $('#id_quantity').on('change paste keyup', function() { return update_after_ship_change(ship_data); } );
    $('#id_payment_method').on('change paste keyup', function() { return update_after_ship_change(ship_data); } );

    update_after_ship_change(ship_data);
});

function update_after_ship_change(ship_data){
    const ship_name = $('#id_ship').find('option:selected').val();
    const quantity = $('#id_quantity').val();
    const current_payment = $('#id_payment_method').find('option:selected').val();
    const selectedCategory = document.querySelector('#id_payment_method');
    selected_ship_data = ship_data[ship_name];
    if(selected_ship_data){
        $('#submit_btn').prop('disabled', false);
        if(selected_ship_data.free){
            free_option = $("#id_payment_method option[value='free']");
            if(free_option.length === 0){
                $('#id_payment_method').append($('<option>', {
                    value: "free",
                    text: "free"
                }));
                M.FormSelect.init(selectedCategory);
            }
            display = "";
            if(selected_ship_data.blocked_until){
                if(current_payment === "free"){
                    olg = selected_ship_data.order_limit_group;
                    display += `<b class="orange-text">Warning: you have already ordered from the ${olg.name} category in the last ${olg.days_between_orders} days.
                    If you place this order it will be blocked from starting until ${selected_ship_data.blocked_until}.</b>`
                }
            } else {
                if(current_payment === "eggs" || current_payment === "isk"){
                    display += "<b class='orange-text'>Warning: you are choosing to pay for this ship which you could have for free if you set the method to free!</b>"
                }
            }
            if(current_payment === "free" && quantity > 1){
                    display = " <h4 class='red-text'>ERROR</h4><b>You cannot order more than one free ship at once. If you wish to pay for the rest make a seperate order for them.</b>";
                    $('#submit_btn').prop('disabled', true);
            }
            $('#ship_info_display').html(display);
        } else {
            $('#id_payment_method option[value="free"]').remove();
            $('#ship_info_display').html("");
            M.FormSelect.init(selectedCategory);
        }
    } else {
        $('#submit_btn').prop('disabled', true);
    }

}


</script>

{% endblock %}
