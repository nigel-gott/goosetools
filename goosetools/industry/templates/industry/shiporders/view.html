{% extends "core/base.html" %}
{% load base_extras %}
{% load static %}
{% load materializecss %}
{% block body %}
<div class="row">
    <div class="col s12 m12">
        <a class="btn waves-btn green" href="{% url 'industry:shiporders_create' %}">Order A Ship!</a>
    </div>
    <div class="col s12 m4">
        <ul class="collection">
            <li class="collection-item">
                <div class="switch">
                    My Requested Orders:
                    <label>
                    Off
                    <input id="toggle_requested" type="checkbox" checked>
                    <span class="lever"></span>
                    On
                    </label>
                </div>
            </li>
            <li class="collection-item">
                <div class="switch">
                    My Assigned Orders:
                    <label>
                    Off
                    <input id="toggle_assigned" type="checkbox">
                    <span class="lever"></span>
                    On
                    </label>
                </div>
            </li>
        </ul>
    </div>
    <div class="col s12 m4">
        <ul class="collection">
            <li class="collection-item">
                <div class="switch">
                    Unassigned Orders:
                    <label>
                    Off
                    <input id="toggle_unassigned" type="checkbox">
                    <span class="lever"></span>
                    On
                    </label>
                </div>
            </li>
        </ul>
    </div>
    <div class="col s12 m4">
        <ul class="collection">
            <li class="collection-item">
                <div class="switch">
                    Archive View:
                    <label>
                    Off
                    <input id="toggle_completed" type="checkbox">
                    <span class="lever"></span>
                    On
                    </label>
                </div>
            </li>
        </ul>
    </div>
    <div class="col s12 m12">
        <table id="ship_orders_table"></table>
    </div>
</div>
{% endblock %}

{% block extrafooter %}
<script src="{% static 'admin/js/vendor/jquery/jquery.js' %}" type="text/javascript"></script>
<link rel="stylesheet" href="https://cdn.datatables.net/1.10.22/css/jquery.dataTables.min.css">
<script src="https://cdn.datatables.net/1.10.22/js/jquery.dataTables.min.js"> </script>
<script src="https://cdn.jsdelivr.net/npm/js-cookie@rc/dist/js.cookie.min.js"></script>
{{ page_data|json_script:"page-data" }}
<script>
$(function() {
    const page_data = JSON.parse(document.getElementById('page-data').textContent);
    columns = [
            { "data": "id", "visible": false, "searchable": false },
            { "data": "created_at", "title": "Created At"},
            { "data": "assignee_name", "title" : "Assignee", "defaultContent": "Nobody",
                render: function ( data, type, row ) {
                    if(page_data["has_industry_permission"]){
                        if(!row["assignee_name"]){
                            return '<button class="claim-btn waves-btn btn green">Claim</button>';
                        } else if(row["assignee"]===page_data["request_user_pk"]){
                            return '<button class="unclaim-btn waves-btn btn red">UnClaim</button>';
                        }
                    }
                    return row['assignee_name'];
                }
            },
            { "data": "recipient_character_name", "title":"Recipient" },
            { "data": "ship", "title":"Ship"},
            { "data": "quantity", "title":"Quantity"},
            { "data": "payment_method", "title":"Payment Method"},
            { "data": "state", "title":"Status",
                render: function ( data, type, row ) {
                    progress_dict = {
                        'not_started':0,
                        'inventing':1,
                        'awaiting_production_slot':2,
                        'building':3,
                        'built':4,
                        'audit':5,
                        'missing_contract':5,
                        'sent':6,
                    }
                    state = row['state']
                    return progress_dict[state] + ": " + state;
                }
            },
            { "data": null, "title": "Progress",
                render: function ( data, type, row ) {
                    progress_dict = {
                        'not_started':0,
                        'inventing':1,
                        'awaiting_production_slot':2,
                        'building':3,
                        'built':4,
                        'audit':5,
                        'missing_contract':5,
                        'sent':6,
                    }
                    state = row['state']
                    progress = Math.floor((progress_dict[state] / 6)*100) + 1;
                    if ( type === 'display' || type === 'filter' ) {
                        return '<div id="progress" style="height:35px;width:100%;background-color:grey;"><div style="height:35px;width:'+progress+'%;background-color:green;"></div></div>';
                    }
                    return progress;
                }
            },
            { "data": "availible_transition_names", "visible": false},
            { "data": "recipient_discord_user_pk", "visible": false, "searchable": false},
            { "data": "assignee", "visible": false, "searchable": false},
    ];
    if(page_data["has_industry_permission"]){
        columns.push({
            "title": "Contract Code",
            "data": "uid",
        });
        columns.push({
            "title": "Action",
            "data": null,
            render: function ( data, type, row ) {
                if(row["assignee"]===page_data["request_user_pk"]){
                    buttons = "";
                    reset_found = false;
                    for(const t of row['availible_transition_names']){
                        if(t!=="reset"){
                            buttons += '<a class="state-link" href="#">' + t + '</a><br/>'
                        } else if(row['state'] !== "not_started") {
                            reset_found = true;
                        }
                    }
                    if(reset_found){
                        buttons += '<a class="state-link red-text" href="#">reset</a><br/>'
                    }
                    return buttons;
                } else {
                    return '';
                }
            }
        });
    }
    table = $('#ship_orders_table').DataTable( {
        pageLength: 50,
        ajax: {
            url: "{% url 'industry:shiporder-list' %}",
            dataSrc: '',
        },
        columns: columns,
    } );

    $('#ship_orders_table').on( 'click', '.state-link', function () {
        const row = table.row( $(this).parents('tr') );
        var data = row.data();
        state_change(row, $(this).text(), table);
    });

    $('#ship_orders_table').on( 'click', '.claim-btn', function () {
        const row = table.row( $(this).parents('tr') );
        var data = row.data();
        claim(row, table);
    });

    $('#ship_orders_table').on( 'click', '.unclaim-btn', function () {
        const row = table.row( $(this).parents('tr') );
        var data = row.data();
        unclaim(row, table);
    });

    loadCheckboxes();

    add_filter(page_data);

    $('input:checkbox').change(filter_change(table));
    filter_change(table)();
});

function django_request(url){
    const csrftoken = Cookies.get('csrftoken');
    return new Request(
        url,
        {headers: {'X-CSRFToken': csrftoken}}
    );
}
function json_django_request(url){
    const csrftoken = Cookies.get('csrftoken');
    return new Request(
        url,
        {headers: {'X-CSRFToken': csrftoken,
            'Content-Type': 'application/json'
        }}
    );
}
function state_change(row, transition, table){
    const id = row.data()['id'];
    const request = json_django_request("shiporder/" + id + "/transition/");
    fetch(request, {
        method: 'PUT',
        mode: 'same-origin',
        body: JSON.stringify({"transition":transition})
    })
    .then(response => response.json())
    .then(response_data => {
        const row_data = row.data();
        row_data['state'] = response_data["new_state"];
        row_data['availible_transition_names'] = response_data["availible_transition_names"];
        row.data(row_data);
        table.draw();
    });
}

function claim(row, table){
    const id = row.data()['id'];
    const request = django_request("shiporder/" + id + "/claim/");
    fetch(request, {
        method: 'PUT',
        mode: 'same-origin'
    })
    .then(response => response.json())
    .then(response_data => {
        const row_data = row.data();
        row_data['assignee_name'] = response_data["assignee_name"];
        row_data['assignee'] = response_data["assignee"];
        row.data(row_data);
        table.draw();
    });
}

function unclaim(row, table){
    const id = row.data()['id'];
    const request = django_request("shiporder/" + id + "/unclaim/");
    fetch(request, {
        method: 'PUT',
        mode: 'same-origin'
    })
    .then(response => response.json())
    .then(response_data => {
        if(response_data["status"] === "unclaimed"){
            const row_data = row.data();
            row_data['assignee_name'] = null;
            row_data['assignee'] = null;
            row.data(row_data);
            table.draw();
        }
    });
}

function filter_change(dt){
    return function(){
        updateStorage();
        dt.draw();
    }
}

function add_filter(page_data){
    $.fn.dataTable.ext.search.push(
        function( settings, data, dataIndex, row ) {
            const assigned = $('#toggle_assigned');
            const unassigned = $('#toggle_unassigned');
            const requested = $('#toggle_requested');
            const completed = $('#toggle_completed');
            const assigned_checked = assigned.is(':checked');
            const unassigned_checked = unassigned.is(':checked');
            const requested_checked = requested.is(':checked');
            const completed_checked = completed.is(':checked');

            if(completed_checked && row['state'] !== 'sent'){
                return false;
            }
            if(!completed_checked && row['state'] === 'sent'){
                return false;
            }

            row_is_assigned_to_user = row['assignee'] === page_data['request_user_pk'];
            row_has_assignee = row['assignee'];
            if(assigned_checked && unassigned_checked){
                return row_is_assigned_to_user || !row_has_assignee;
            } else if(assigned_checked){
                return row_is_assigned_to_user;
            } else if (unassigned_checked){
                return !row_has_assignee;
            } else if(requested_checked){
                return parseInt(row['recipient_discord_user_pk']) === page_data['request_discord_user_pk'];
            } else {
                return true;
            }
        }
    );

}


function updateStorage(){
    checkboxValues = {};
    const $checkboxes = $(":checkbox");
    $checkboxes.each(function(){
        checkboxValues[this.id] = this.checked;
    });

    localStorage.setItem("checkboxValues", JSON.stringify(checkboxValues));
}

function loadCheckboxes(){
    var checkboxValues = JSON.parse(localStorage.getItem('checkboxValues')) || {};
    $.each(checkboxValues, function(key, value) {
        if(key){
            $("#" + key).prop('checked', value);
        }
    });
}
</script>
{% endblock %}
